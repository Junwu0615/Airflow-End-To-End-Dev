pipeline {
    agent any

    environment {
        REPO_DIR = "."
//         DOCKER_AIRFLOW_NAME = "airflow_webserver_1" // ç¢ºä¿é€™æ˜¯æ‚¨çš„å®¹å™¨åç¨±
        DOCKER_AIRFLOW_NAME = "etl-task-airflow-airflow-webserver-1"
        DEPLOY_TARGET_DIR = "/jenkins-workspace/airflow-project" // Jenkins å®¹å™¨å…§æ›è¼‰çš„å…±äº«å·è·¯å¾‘
    }

    stages {
        // [å¯é¸] CI éšæ®µ

        // [é‡é»] CD éšæ®µ
        stage('Deploy Files via Docker Volume') {
            when { expression { currentBuild.currentResult == 'SUCCESS' } }
            steps {
                sh """
                echo "ğŸ“¦ Deploying files to shared volume..."

                # 1. è¤‡è£½ dags/ å…§å®¹åˆ°å…±äº«ç›®éŒ„
                cp -Rf ${REPO_DIR}/dags/* ${DEPLOY_TARGET_DIR}/dags/

                # 2. è¤‡è£½ lib/ å…§å®¹åˆ°å…±äº«ç›®éŒ„
                cp -Rf ${REPO_DIR}/lib/* ${DEPLOY_TARGET_DIR}/lib/

                echo "âœ… Deployment successful."
                """
            }
        }

        stage('Trigger Airflow DAG') {
            when { expression { currentBuild.currentResult == 'SUCCESS' } }
            steps {
                sh """
                echo "â³ Waiting for Airflow Scheduler to parse DAG (15 seconds)..."
                # é—œéµä¿®æ­£ 3: å¢åŠ ç­‰å¾…æ™‚é–“ (15 ç§’)ï¼Œè®“ Airflow è¼‰å…¥æ–° DAGï¼Œé¿å… DagNotFound
                sleep 15

                echo "ğŸš€ Unpausing and Triggering DAG: etl_branch_xcom_demo"

                # é—œéµä¿®æ­£ 4: å…ˆ unpause ç¢ºä¿ DAG è™•æ–¼æ´»å‹•ç‹€æ…‹ï¼Œä¸¦å¼·åˆ¶ Airflow æª¢æŸ¥
                docker exec ${DOCKER_AIRFLOW_NAME} airflow dags unpause etl_branch_xcom_demo

                # 5. è§¸ç™¼ DAG
                docker exec ${DOCKER_AIRFLOW_NAME} airflow dags trigger etl_branch_xcom_demo

                echo "âœ… Airflow Trigger command sent."
                """
            }
        }
    }
}